<div class="calendar-layout">
  <!-- Left Column: Event List -->
  <div class="events-sidebar">
    <div class="view-selector">
      <label for="viewType">View:</label>
      <select id="viewType" [(ngModel)]="viewType" (change)="onViewChange()">
        <option value="month">Current Month</option>
        <option value="week">Current Week</option>
        <option value="day">Today</option>
        <option value="next30">Next 30 Days</option>
        <option value="next7">Next 7 Days</option>
        <option value="next2">Next 2 Days</option>
        <option value="nextMonth">Next Month</option>
        <option value="pastMonth">Past Month</option>
        <option value="pastWeek">Past Week</option>
        <option value="past2">Past 2 Days</option>
        <option value="allPassed">All Passed Events</option>
      </select>
    </div>

    <div class="events-list-container">
      <h3>{{ getEventListTitle() }}</h3>
      <div class="events-list">
        <div *ngIf="filteredEvents.length === 0" class="empty-state">
          No events for this {{ viewType }}
        </div>
        <div *ngFor="let event of filteredEvents; let i = index"
             class="event-item"
             [class.even-row]="i % 2 === 0"
             [class.odd-row]="i % 2 === 1"
             [class.snooze-occurrence]="event.isSnoozeOccurrence"
             draggable="true"
             (dragstart)="onDragStart(event, $event)">
          <div class="event-content">
            <div class="event-title">
              <span *ngIf="event.isSnoozeOccurrence">ðŸ””</span>
              <span *ngIf="!event.isSnoozeOccurrence">ðŸ“…</span>
              {{ event.title }}
            </div>
            <div class="event-date">{{ event.targetDate | date:'MMM d, y h:mm a' }}</div>
            <div *ngIf="event.description" class="event-description">{{ event.description }}</div>
          </div>
          <div class="event-actions">
            <button class="navigate-btn" (click)="startEditEvent(event)" title="Edit Event">
              <i class="glyphicon glyphicon-pencil"></i>
            </button>
            <button class="navigate-btn" (click)="showSnoozeModal(event)" title="Snooze Event">
              <i class="glyphicon glyphicon-time"></i>
            </button>
            <button class="navigate-btn" (click)="navigateToEventInCategories(event.id, event.categoryID)" title="Go to Categories">
              <i class="glyphicon glyphicon-folder-open"></i>
            </button>
            <button class="delete-btn" (click)="deleteEvent(event.id)" title="Delete Event">
              <i class="glyphicon glyphicon-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column: Calendar -->
  <div class="calendar-container">
    <div class="calendar-header">
      <button (click)="previousMonth()" class="nav-btn">
        <i class="glyphicon glyphicon-chevron-left"></i>
      </button>
      <h2>{{ monthNames[currentMonth] }} {{ currentYear }}</h2>
      <button (click)="nextMonth()" class="nav-btn">
        <i class="glyphicon glyphicon-chevron-right"></i>
      </button>
    </div>

    <div class="calendar-grid">
      <div class="day-header">Sun</div>
      <div class="day-header">Mon</div>
      <div class="day-header">Tue</div>
      <div class="day-header">Wed</div>
      <div class="day-header">Thu</div>
      <div class="day-header">Fri</div>
      <div class="day-header">Sat</div>

      <div
        *ngFor="let day of calendarDays"
        class="calendar-day"
        [class.other-month]="!day.isCurrentMonth"
        [class.today]="day.isToday"
        [class.has-events]="day.events.length > 0"
        (click)="selectDay(day.date)"
        (dblclick)="openCreateEventModal(day.date)"
        (dragover)="onDragOver($event)"
        (drop)="onDrop(day, $event)">

        <div class="day-number">{{ day.day }}</div>
        <div class="add-event-btn" (click)="openCreateEventModal(day.date); $event.stopPropagation()" title="Add Event">+</div>

        <div class="events-preview" *ngIf="day.events.length > 0">
          <div
            *ngFor="let event of day.events.slice(0, 2)"
            class="event-dot"
            [class.snooze-dot]="event.isSnoozeOccurrence"
            [title]="(event.isSnoozeOccurrence ? 'ðŸ”” ' : '') + event.title">
            {{ event.title.substring(0, 8) }}{{ event.title.length > 8 ? '...' : '' }}
          </div>
          <div *ngIf="day.events.length > 2" class="more-events">
            +{{ day.events.length - 2 }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Event Details Popup -->
<div *ngIf="selectedEvent" class="modal-overlay" (click)="closeEventPopup()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ selectedEvent.title }}</h3>
      <div class="header-actions">
        <button class="edit-btn" (click)="startEditEvent()" *ngIf="!isEditingEvent">
          <i class="glyphicon glyphicon-pencil"></i>
        </button>
        <button class="close-btn" (click)="closeEventPopup()">
          <i class="glyphicon glyphicon-remove"></i>
        </button>
      </div>
    </div>

    <div class="event-details">
      <!-- View Mode -->
      <div *ngIf="!isEditingEvent">
        <div class="detail-row">
          <strong>Date & Time:</strong>
          <span>{{ selectedEvent.targetDate | date:'MMM d, y h:mm a' }}</span>
        </div>

        <div *ngIf="selectedEvent.description" class="detail-row">
          <strong>Description:</strong>
          <span>{{ selectedEvent.description }}</span>
        </div>

        <div class="detail-row">
          <strong>Category:</strong>
          <span>{{ getCategoryName(selectedEvent.categoryID) }}</span>
        </div>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditingEvent" class="edit-form">
        <div class="form-group">
          <label>Title:</label>
          <input type="text" [(ngModel)]="editingEventData.title" class="form-input">
        </div>

        <div class="form-group">
          <label>Date & Time:</label>
          <input type="datetime-local" [(ngModel)]="editingEventData.targetDate" class="form-input">
        </div>

        <div class="form-group">
          <label>Description:</label>
          <textarea [(ngModel)]="editingEventData.description" class="form-textarea"></textarea>
        </div>

        <div class="form-group">
          <label>Root Category:</label>
          <select [(ngModel)]="editingEventData.rootCategoryID" (change)="onEditingRootCategoryChange()" class="form-input">
            <option value="">No Category</option>
            <option *ngFor="let category of rootCategories" [value]="category.id">{{ category.name }}</option>
          </select>
        </div>

        <div class="form-group" *ngIf="editingSubcategories.length > 0">
          <label>Subcategory:</label>
          <select [(ngModel)]="editingEventData.subcategoryID" (change)="updateEditingCategoryID()" class="form-input">
            <option value="">Select subcategory (optional)</option>
            <option *ngFor="let subcategory of editingSubcategories" [value]="subcategory.id">{{ subcategory.name }}</option>
          </select>
        </div>

        <div class="edit-actions">
          <button class="save-btn" (click)="saveEventEdit()">Save</button>
          <button class="cancel-btn" (click)="cancelEventEdit()">Cancel</button>
        </div>
      </div>

      <div class="detail-row">
        <strong>Time Remaining:</strong>
        <div class="countdown-display" [ngClass]="{
          'expired': selectedEventCountdown?.expired,
          'urgent': !selectedEventCountdown?.expired && (selectedEventCountdown?.days || 0) < 3,
          'warning': !selectedEventCountdown?.expired && (selectedEventCountdown?.days || 0) >= 3 && (selectedEventCountdown?.days || 0) < 7,
          'caution': !selectedEventCountdown?.expired && (selectedEventCountdown?.days || 0) >= 7 && (selectedEventCountdown?.days || 0) < 14
        }">
          <div *ngIf="!selectedEventCountdown?.expired" class="countdown-timer">
            <span class="countdown-item">
              <strong>{{ selectedEventCountdown?.days || 0 }}</strong> days
            </span>
            <span class="countdown-item">
              <strong>{{ selectedEventCountdown?.hours || 0 }}</strong> hours
            </span>
            <span class="countdown-item">
              <strong>{{ selectedEventCountdown?.minutes || 0 }}</strong> minutes
            </span>
            <span class="countdown-item">
              <strong>{{ selectedEventCountdown?.seconds || 0 }}</strong> seconds
            </span>
          </div>
          <div *ngIf="selectedEventCountdown?.expired" class="expired-message">
            Event has passed!
          </div>
        </div>
      </div>

      <div class="detail-row">
        <strong>Todo Items:</strong>
        <div class="todos-container">
          <app-todo-list [eventId]="selectedEvent.id"></app-todo-list>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Date/Time Selection Modal -->
<div *ngIf="showDateTimeModal" class="modal-overlay" (click)="closeDateTimeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Set New Date & Time</h3>
      <button class="close-btn" (click)="closeDateTimeModal()">
        <i class="glyphicon glyphicon-remove"></i>
      </button>
    </div>

    <div class="datetime-form">
      <div class="form-group">
        <label>Event: {{ draggedEvent?.title }}</label>
      </div>

      <div class="form-group">
        <label>New Date & Time:</label>
        <input type="datetime-local" [(ngModel)]="newDateTime" class="form-input">
      </div>

      <div class="modal-actions">
        <button class="save-btn" (click)="confirmDateTimeChange()">Update Event</button>
        <button class="cancel-btn" (click)="closeDateTimeModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Event Modal -->
<div *ngIf="showCreateEventModal" class="modal-overlay" (click)="closeCreateEventModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Create New Event</h3>
      <button class="close-btn" (click)="closeCreateEventModal()">
        <i class="glyphicon glyphicon-remove"></i>
      </button>
    </div>

    <div class="create-event-form">
      <div class="form-group">
        <label>Title *:</label>
        <input type="text" [(ngModel)]="newEventData.title" class="form-input" placeholder="Enter event title">
      </div>

      <div class="form-group">
        <label>Date & Time:</label>
        <input type="datetime-local" [(ngModel)]="newEventData.targetDate" class="form-input">
      </div>

      <div class="form-group">
        <label>Description:</label>
        <textarea [(ngModel)]="newEventData.description" class="form-textarea" placeholder="Enter event description (optional)"></textarea>
      </div>

      <div class="form-group">
        <label>Category (Root):</label>
        <select [(ngModel)]="newEventData.categoryID" (change)="onCategoryChange()" class="form-input">
          <option value="">Select a category (optional)</option>
          <option *ngFor="let category of rootCategories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
      </div>

      <div class="form-group" *ngIf="subcategories.length > 0">
        <label>Subcategory:</label>
        <select [(ngModel)]="newEventData.subcategoryID" class="form-input">
          <option value="">Select a subcategory (optional)</option>
          <option *ngFor="let subcategory of subcategories" [value]="subcategory.id">
            {{ subcategory.name }}
          </option>
        </select>
      </div>

      <div class="modal-actions">
        <button class="save-btn" (click)="createEvent()">Create Event</button>
        <button class="cancel-btn" (click)="closeCreateEventModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Snooze modal -->
<div *ngIf="snoozeEvent" class="modal-overlay">
  <div class="modal-content">
    <h3>Snooze Event: {{ snoozeEvent.title }}</h3>
    <div class="snooze-options">
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="once" name="snoozeType">
        Snooze once
      </label>
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="daily" name="snoozeType">
        Daily recurrence
      </label>
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="weekly" name="snoozeType">
        Weekly recurrence
      </label>
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="custom" name="snoozeType">
        Custom interval
      </label>
    </div>
    
    <div *ngIf="snoozeType === 'weekly'" class="weekly-options">
      <label>Select days:</label>
      <div class="weekdays">
        <label *ngFor="let day of weekdays; let i = index">
          <input type="checkbox" [(ngModel)]="selectedWeekdays[i]">
          {{ day }}
        </label>
      </div>
    </div>
    
    <div *ngIf="snoozeType === 'custom'" class="custom-interval">
      <input type="number" [(ngModel)]="customInterval" min="1" placeholder="Interval">
      <select [(ngModel)]="customUnit">
        <option value="days">Days</option>
        <option value="weeks">Weeks</option>
        <option value="months">Months</option>
      </select>
    </div>
    
    <div class="snooze-datetime">
      <div class="date-section">
        <label>Start Date:</label>
        <input type="date" [(ngModel)]="snoozeDate" required>
      </div>
    </div>
    
    <style>
      .snooze-datetime {
        display: flex;
        gap: 20px;
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #f9f9f9;
      }
      .date-section, .time-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .date-section label, .time-section label {
        font-weight: 600;
        color: #333;
      }
      .date-section input, .time-section input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
    
    <div *ngIf="snoozeType !== 'once'" class="end-date">
      <label>End recurrence (optional):</label>
      <input type="date" [(ngModel)]="recurrenceEndDate">
    </div>
    
    <div class="modal-actions">
      <button (click)="confirmSnooze()" class="save-btn">Snooze</button>
      <button (click)="clearSnooze()" class="clear-btn" *ngIf="snoozeEvent?.snoozeDates">Clear Snooze</button>
      <button (click)="cancelSnooze()" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>
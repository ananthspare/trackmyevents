<div class="two-column-layout">
  <!-- Left Column: Categories (with draggable handle) -->
  <div class="categories-sidebar" id="categoriesSidebar">
    <div class="sidebar-header">
      <h2>Categories</h2>
    </div>

    <!-- Add new category form -->
    <form (ngSubmit)="createCategory()" class="add-category-form">
      <input
        type="text"
        [(ngModel)]="newCategory.name"
        name="categoryName"
        placeholder="Category name"
        required
      />
      <input
        type="text"
        [(ngModel)]="newCategory.description"
        name="categoryDescription"
        placeholder="Description (optional)"
      />
      <select [(ngModel)]="newCategory.parentCategoryID" name="parentCategory" class="parent-select">
        <option [ngValue]="null">Root Category</option>
        <option *ngFor="let category of rootCategories" [ngValue]="category.id">
          {{ category.name }}
        </option>
      </select>
      <button type="submit" class="add-category-btn">
        <i class="glyphicon glyphicon-plus"></i>
        <span>Add Category</span>
      </button>
    </form>

    <!-- Categories list -->
    <div class="categories-list"
         (dragover)="onDragOver($event)"
         (drop)="onDrop($event)">
      <div *ngIf="categories.length === 0" class="empty-state">
        No categories yet. Create one to get started!
      </div>

      <!-- Root categories -->
      <ng-container *ngFor="let category of rootCategories">
        <div class="category-item"
             [class.active]="selectedCategoryId === category.id"
             (click)="selectCategory(category.id)"
             draggable="true"
             (dragstart)="onDragStart($event, category.id)"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event, category.id)"
             (dragend)="onDragEnd($event)">
          <div class="category-header">
            <div class="category-title-section">
              <button *ngIf="hasSubcategories(category.id)"
                      (click)="toggleCategoryExpansion(category.id, $event)"
                      class="expand-btn">
                <i class="glyphicon"
                   [class.glyphicon-chevron-down]="expandedCategories.has(category.id)"
                   [class.glyphicon-chevron-right]="!expandedCategories.has(category.id)"></i>
              </button>
              <h3 [title]="category.name">{{ category.name }}</h3>
            </div>
            <div class="category-actions">
              <button (click)="addSubcategory(category.id, $event)" class="icon-btn" title="Add subcategory">
                <i class="glyphicon glyphicon-plus-sign"></i>
              </button>
              <button (click)="startEdit(category); $event.stopPropagation()" class="icon-btn" title="Edit category">
                <i class="glyphicon glyphicon-pencil"></i>
              </button>
              <button (click)="deleteCategory(category.id); $event.stopPropagation()" class="icon-btn" title="Delete category">
                <i class="glyphicon glyphicon-trash"></i>
              </button>
            </div>
          </div>
          <p *ngIf="category.description"
             class="category-description"
             [title]="category.description">
            {{ category.description }}
          </p>
        </div>

        <!-- Subcategories (one level only) -->
        <div *ngIf="expandedCategories.has(category.id) && subcategories[category.id]" class="subcategories-container">
          <div *ngFor="let subcategory of subcategories[category.id]"
               class="category-item subcategory-item"
               [class.active]="selectedCategoryId === subcategory.id"
               (click)="selectCategory(subcategory.id)"
               draggable="true"
               (dragstart)="onDragStart($event, subcategory.id)"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event, subcategory.id)"
               (dragend)="onDragEnd($event)">
            <div class="category-header">
              <div class="category-title-section">
                <h3 [title]="subcategory.name">{{ subcategory.name }}</h3>
              </div>
              <div class="category-actions">
                <button (click)="promoteToRoot(subcategory.id); $event.stopPropagation()" class="icon-btn" title="Promote to root">
                  <i class="glyphicon glyphicon-arrow-up"></i>
                </button>
                <button (click)="startEdit(subcategory); $event.stopPropagation()" class="icon-btn" title="Edit category">
                  <i class="glyphicon glyphicon-pencil"></i>
                </button>
                <button (click)="deleteCategory(subcategory.id); $event.stopPropagation()" class="icon-btn" title="Delete category">
                  <i class="glyphicon glyphicon-trash"></i>
                </button>
              </div>
            </div>
            <p *ngIf="subcategory.description"
               class="category-description"
               [title]="subcategory.description">
              {{ subcategory.description }}
            </p>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Resize handle -->
  <div class="resize-handle" id="resizeHandle"
       (touchstart)="onTouchStart($event)"
       (touchmove)="onTouchMove($event)"
       (touchend)="onTouchEnd($event)"></div>

  <!-- Right Column: Events -->
  <div class="events-content">
    <div *ngIf="selectedCategory" class="events-container">
      <h2>Events and To-dos for {{ selectedCategory.name }}</h2>
      <div *ngIf="selectedCategory.parentCategoryID" class="parent-category-info">
        <span>Subcategory of: {{ getCategoryName(selectedCategory.parentCategoryID) }}</span>
      </div>

      <!-- Category Todos section -->
      <div class="category-todos-section">
        <div class="todos-header">
          <h3>To-dos for {{ selectedCategory.name }}</h3>
        </div>

        <div class="add-todo-form">
          <input
            type="text"
            [(ngModel)]="newCategoryTodo"
            placeholder="Add a to-do for this category..."
            (keyup.enter)="createCategoryTodo()"
            class="todo-input"
          />
          <button (click)="createCategoryTodo()" class="add-todo-btn">
            <i class="glyphicon glyphicon-plus"></i>
          </button>
        </div>

        <div class="todos-list">
          <div *ngIf="categoryTodos.length === 0" class="no-todos">
            No to-dos yet. Add one above.
          </div>

          <div *ngFor="let todo of categoryTodos" class="todo-item" [class.completed]="todo.isDone">
            <div *ngIf="editingCategoryTodo?.id !== todo.id" class="todo-view">
              <input
                type="checkbox"
                [checked]="todo.isDone"
                (change)="toggleCategoryTodo(todo)"
                class="todo-checkbox"
              />
              <span class="todo-content" [class.completed]="todo.isDone">
                {{ todo.content }}
              </span>
              <div class="todo-actions">
                <button (click)="startEditCategoryTodo(todo)" class="edit-todo-btn">
                  <i class="glyphicon glyphicon-pencil"></i>
                </button>
                <button (click)="deleteCategoryTodo(todo.id)" class="delete-todo-btn">
                  <i class="glyphicon glyphicon-trash"></i>
                </button>
              </div>
            </div>
            <div *ngIf="editingCategoryTodo?.id === todo.id" class="todo-edit">
              <input
                type="text"
                [(ngModel)]="editingCategoryTodo.content"
                class="edit-todo-input"
              />
              <div class="edit-todo-actions">
                <button (click)="saveEditCategoryTodo()" class="save-btn">Save</button>
                <button (click)="cancelEditCategoryTodo()" class="cancel-btn">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Events section -->
      <div class="events-section">
        <h3>Events for {{ selectedCategory.name }}</h3>

        <!-- Add new event form -->
      <div class="add-event-form">
        <input
          type="text"
          [(ngModel)]="newEvent.title"
          placeholder="Event title"
          required
        />
        <input
          type="text"
          [(ngModel)]="newEvent.description"
          placeholder="Description (optional)"
        />
        <input
          type="datetime-local"
          [(ngModel)]="newEvent.targetDate"
          placeholder="Target date"
          required
        />
        <button (click)="createEvent()">
          <i class="glyphicon glyphicon-plus"></i>
        </button>
      </div>

      <!-- Events list -->
      <div class="events-list">
        <div *ngIf="events.length === 0" class="empty-state">
          No events yet. Create one to get started!
        </div>

        <div *ngFor="let event of events; let i = index"
             class="event-item"
             [class.even-row]="i % 2 === 0"
             [class.odd-row]="i % 2 === 1"
             [class.highlighted]="highlightedEventId === event.id"
             [attr.data-event-id]="event.id">
          <!-- View mode -->
          <div *ngIf="editingEvent?.id !== event.id" class="event-view">
            <div class="event-header-section">
              <div class="event-content-row">
                <div class="event-text-section">
                  <h3>{{ event.title }}</h3>
                  <p *ngIf="event.description" class="event-description">{{ event.description }}</p>
                </div>

                <div class="countdown-section">
                    <div class="countdown-inline" [ngClass]="{
                      'expired': countdowns[event.id]?.expired,
                      'urgent': !countdowns[event.id]?.expired && (countdowns[event.id]?.days || 0) < 3,
                      'warning': !countdowns[event.id]?.expired && (countdowns[event.id]?.days || 0) >= 3 && (countdowns[event.id]?.days || 0) < 7,
                      'caution': !countdowns[event.id]?.expired && (countdowns[event.id]?.days || 0) >= 7 && (countdowns[event.id]?.days || 0) < 14
                    }">
                      <div *ngIf="!countdowns[event.id]?.expired" class="countdown-timer-inline">
                        <span class="countdown-item-inline">
                          <strong>{{ countdowns[event.id]?.days || 0 }}</strong>d
                        </span>
                        <span class="countdown-item-inline">
                          <strong>{{ countdowns[event.id]?.hours || 0 }}</strong>h
                        </span>
                        <span class="countdown-item-inline">
                          <strong>{{ countdowns[event.id]?.minutes || 0 }}</strong>m
                        </span>
                        <span class="countdown-item-inline">
                          <strong>{{ countdowns[event.id]?.seconds || 0 }}</strong>s
                        </span>
                      </div>
                      <div *ngIf="countdowns[event.id]?.expired" class="expired-message-inline">
                        Event passed!
                      </div>
                    </div>
                    <div *ngIf="event.targetDate" class="target-date" [ngClass]="{
                      'urgent': !countdowns[event.id]?.expired && (countdowns[event.id]?.days || 0) < 3,
                      'warning': !countdowns[event.id]?.expired && (countdowns[event.id]?.days || 0) >= 3 && (countdowns[event.id]?.days || 0) < 7,
                      'caution': !countdowns[event.id]?.expired && (countdowns[event.id]?.days || 0) >= 7 && (countdowns[event.id]?.days || 0) < 14
                    }">
                      {{ event.targetDate | date:'MMM d, y H:mm' }}
                    </div>
                    <div class="event-actions">
                      <button class="drag-handle"
                              draggable="true"
                              (dragstart)="onEventDragStart($event, event.id)"
                              (dragend)="onEventDragEnd($event)"
                              title="Drag to move event">
                        <i class="glyphicon glyphicon-move"></i>
                      </button>
                      <button (click)="startEditEvent(event)" class="icon-btn">
                        <i class="glyphicon glyphicon-pencil"></i>
                      </button>
                      <button (click)="showSnoozeModal(event)" class="icon-btn snooze-btn">
                        <i class="glyphicon glyphicon-time"></i>
                      </button>
                      <button (click)="deleteEvent(event.id)" class="icon-btn">
                        <i class="glyphicon glyphicon-trash"></i>
                      </button>
                    </div>
                </div>
              </div>
            </div>

            <!-- Todo list for this event -->
            <app-todo-list [eventId]="event.id"></app-todo-list>
          </div>

          <!-- Edit mode -->
          <div *ngIf="editingEvent?.id === event.id" class="event-edit">
            <input
              type="text"
              [(ngModel)]="editingEvent.title"
              placeholder="Event title"
              required
            />
            <input
              type="text"
              [(ngModel)]="editingEvent.description"
              placeholder="Description (optional)"
            />
            <input
              type="datetime-local"
              [(ngModel)]="editingEvent.targetDate"
              placeholder="Target date"
              required
            />
            <select [(ngModel)]="editingEvent.categoryID" class="category-select">
              <optgroup label="Root Categories">
                <option *ngFor="let category of rootCategories" [value]="category.id">
                  {{ category.name }}
                </option>
              </optgroup>
              <optgroup *ngFor="let parentId of getParentIds()" [label]="getCategoryName(parentId) + ' - Subcategories'">
                <option *ngFor="let subcategory of subcategories[parentId]" [value]="subcategory.id">
                  {{ subcategory.name }}
                </option>
              </optgroup>
            </select>
            <div class="edit-actions">
              <button (click)="saveEditEvent()" class="save-btn">Save</button>
              <button (click)="cancelEditEvent()" class="cancel-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <div *ngIf="!selectedCategory" class="no-selection">
      <p>Select a category to view events</p>
    </div>
  </div>
</div>

<!-- Edit category modal -->
<div *ngIf="editingCategory" class="modal-overlay">
  <div class="modal-content">
    <h3>Edit Category</h3>
    <input
      type="text"
      [(ngModel)]="editingCategory.name"
      name="editName"
      placeholder="Category name"
      required
    />
    <input
      type="text"
      [(ngModel)]="editingCategory.description"
      name="editDescription"
      placeholder="Description (optional)"
    />
    <div class="parent-category-selector">
      <label for="parentCategory">Parent Category:</label>
      <select [(ngModel)]="editingCategory.parentCategoryID" name="parentCategory" id="parentCategory">
        <option [ngValue]="null">None (Root Category)</option>
        <option *ngFor="let category of rootCategories"
                [ngValue]="category.id"
                [disabled]="category.id === editingCategory.id">
          {{ category.name }}
        </option>
      </select>
    </div>
    <div class="edit-actions">
      <button (click)="saveEdit()" class="save-btn">Save</button>
      <button (click)="cancelEdit()" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<!-- Snooze modal -->
<div *ngIf="snoozeEvent" class="modal-overlay">
  <div class="modal-content">
    <h3>Snooze Event: {{ snoozeEvent.title }}</h3>
    <div class="snooze-options">
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="once" name="snoozeType">
        Snooze once
      </label>
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="daily" name="snoozeType">
        Daily recurrence
      </label>
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="weekly" name="snoozeType">
        Weekly recurrence
      </label>
      <label>
        <input type="radio" [(ngModel)]="snoozeType" value="custom" name="snoozeType">
        Custom interval
      </label>
    </div>

    <div *ngIf="snoozeType === 'weekly'" class="weekly-options">
      <label>Select days:</label>
      <div class="weekdays">
        <label *ngFor="let day of weekdays; let i = index">
          <input type="checkbox" [(ngModel)]="selectedWeekdays[i]">
          {{ day }}
        </label>
      </div>
      <label>Time:</label>
      <input type="time" [(ngModel)]="weeklyTime">
    </div>

    <div *ngIf="snoozeType === 'custom'" class="custom-interval">
      <input type="number" [(ngModel)]="customInterval" min="1" placeholder="Interval">
      <select [(ngModel)]="customUnit">
        <option value="days">Days</option>
        <option value="weeks">Weeks</option>
        <option value="months">Months</option>
      </select>
    </div>

    <div class="snooze-date">
      <label>New date:</label>
      <input type="date" [(ngModel)]="newSnoozeDate" required>
    </div>

    <div *ngIf="snoozeType !== 'once'" class="end-date">
      <label>End recurrence (optional):</label>
      <input type="date" [(ngModel)]="recurrenceEndDate">
    </div>

    <div class="modal-actions">
      <button (click)="confirmSnooze()" class="save-btn">Snooze</button>
      <button (click)="clearSnooze()" class="clear-btn" *ngIf="snoozeEvent?.snoozeDates">Clear Snooze</button>
      <button (click)="cancelSnooze()" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

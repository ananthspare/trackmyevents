<div class="planner-container">
  <div class="planner-header">
    <h2>Day Planner</h2>
    <div class="controls-wrapper">
      <input type="date" [(ngModel)]="selectedDate" (change)="loadPlan()" class="date-input">
      <div class="view-selector">
        <label>View:</label>
        <select [(ngModel)]="plannerView" (change)="onPlannerViewChange()">
          <option value="today">Today</option>
          <option value="week">Whole Week</option>
          <option value="workweek">Work Week</option>
          <option value="month">Monthly</option>
        </select>
      </div>
      <div class="time-range">
        <label>From:</label>
        <select [(ngModel)]="startHour" (change)="onTimeRangeChange()">
          <option *ngFor="let hour of hours" [value]="hour">{{ hour.toString().padStart(2, '0') }}:00</option>
        </select>
        <label>To:</label>
        <select [(ngModel)]="endHour" (change)="onTimeRangeChange()">
          <option *ngFor="let hour of hours" [value]="hour">{{ hour.toString().padStart(2, '0') }}:00</option>
        </select>
      </div>
    </div>
    <div class="header-actions">
      <button (click)="copyToNextDay()" [disabled]="copying" class="copy-btn">
        {{ copying ? 'Copying...' : 'Copy to Next Day' }}
      </button>
      <button (click)="copyToWeek()" [disabled]="copying" class="copy-btn">
        {{ copying ? 'Copying...' : 'Copy to Week' }}
      </button>
      <button (click)="saveAllTasks()" [disabled]="saving" class="save-all-btn">
        {{ saving ? 'Saving...' : 'Save All Tasks' }}
      </button>
    </div>
  </div>

  <div class="planner-body">
    <div class="planner-main" id="plannerMain">
      <!-- Day View -->
      <div class="planner-table" #plannerTable *ngIf="plannerView === 'today'">
        <div class="time-slot" 
             *ngFor="let slot of timeSlots; trackBy: trackByTime"
             [id]="'time-slot-' + slot.time"
             [class.current-time-slot]="currentTimeSlotId === slot.time">
          <div class="time-label">{{ slot.timeRange }}</div>
          <div class="slot-content">
            <button (click)="pinTask(slot)" class="pin-task-btn" title="Pin this task">📌</button>
            <textarea
              [(ngModel)]="slot.task"
              class="task-input"
              placeholder="Add task..."
              rows="3"></textarea>
            <div *ngFor="let event of slot.events" class="event-item" [class.snooze-event]="event.isSnoozeOccurrence">
              <span *ngIf="event.isSnoozeOccurrence">🔔</span>
              <span *ngIf="!event.isSnoozeOccurrence">📅</span>
              {{ event.title }}
              <div class="event-description" *ngIf="event.description">{{ event.description }}</div>
              <span *ngIf="event.isSnoozeOccurrence" class="original-date">Original: {{ getOriginalDate(event.targetDate) }}</span>
              <span class="navigate-icon" (click)="navigateToEvent(event.id, event.categoryID)" title="Go to event and category">📁</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Week Views -->
      <div class="week-grid" *ngIf="plannerView === 'week' || plannerView === 'workweek'">
        <div class="week-header" [class.full-week]="plannerView === 'week'" [class.work-week]="plannerView === 'workweek'">
          <div class="time-column-header">Time</div>
          <div class="day-header" *ngFor="let day of weekDays">{{ day | date:'EEE MMM d' }}</div>
        </div>
        <div class="week-row" [class.full-week]="plannerView === 'week'" [class.work-week]="plannerView === 'workweek'" *ngFor="let slot of filteredTimeSlots">
          <div class="time-label">{{ slot.timeRange }}</div>
          <div class="day-cell" *ngFor="let day of weekDays">
            <div class="task-editor-mini">
              <textarea
                [(ngModel)]="dayTasks[day][slot.time]"
                class="day-task-input-rich"
                placeholder="Tasks..."
                rows="2"></textarea>
            </div>
            <div *ngFor="let event of getDayEvents(day, slot.time)" class="event-item" [class.snooze-event]="event.isSnoozeOccurrence">
              <span *ngIf="event.isSnoozeOccurrence">🔔</span>
              <span *ngIf="!event.isSnoozeOccurrence">📅</span>
              {{ event.title }}
            </div>
          </div>
        </div>
      </div>

      <!-- Month View -->
      <div class="month-grid" *ngIf="plannerView === 'month'">
        <div class="month-header">
          <div class="day-name" *ngFor="let dayName of ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']">{{ dayName }}</div>
        </div>
        <div class="month-row" *ngFor="let week of monthWeeks">
          <div class="month-day" *ngFor="let day of week" (click)="selectDayInMonth(day.date)" [class.other-month]="!day.isCurrentMonth" [class.today]="isToday(day.date)">
            <div class="day-number">{{ day.day }}</div>
            <div class="day-tasks-preview">{{ getDayTasksCount(day.date) }} tasks</div>
            <div class="day-events-preview">{{ getDayEventsCount(day.date) }} events</div>
          </div>
        </div>
      </div>
    </div>

    <div class="resize-handle" id="resizeHandle" 
         (touchstart)="onTouchStart($event)"
         (touchmove)="onTouchMove($event)"
         (touchend)="onTouchEnd($event)"></div>

    <div class="pinned-sidebar" id="pinnedSidebar">
      <div class="pinned-header">
        <h3>Pinned Tasks</h3>
        <span class="pinned-date">{{ selectedDate | date:'MMM d, y' }}</span>
      </div>
      
      <div class="add-pinned-form">
        <textarea 
          [(ngModel)]="newPinnedTask" 
          placeholder="Add pinned task..." 
          rows="2"
          class="pinned-input"></textarea>
        <button (click)="addPinnedTask()" class="add-pinned-btn">Pin</button>
      </div>

      <div class="pinned-list">
        <div *ngIf="pinnedTasks.length === 0" class="empty-pinned">
          No pinned tasks yet
        </div>
        
        <div *ngFor="let task of pinnedTasks; let i = index" 
             class="pinned-item" 
             [class.editing]="editingTaskIndex === i"
             draggable="true"
             (dragstart)="onDragStart($event, i)"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event, i)">
          
          <!-- View Mode -->
          <div *ngIf="editingTaskIndex !== i" class="pinned-view">
            <div class="drag-handle">⋮⋮</div>
            <div class="pinned-content" (click)="startEditTask(i)">{{ task.content }}</div>
            <div class="pinned-actions">
              <button (click)="togglePinnedComplete(i)" 
                      class="complete-btn" 
                      title="Mark as complete">
                ✓
              </button>
              <button (click)="movePinnedTask(i)" class="move-btn" title="Move to another day">
                →
              </button>
              <button (click)="removePinnedTask(i)" class="remove-btn" title="Remove">
                ×
              </button>
            </div>
          </div>
          
          <!-- Edit Mode -->
          <div *ngIf="editingTaskIndex === i" class="pinned-edit">
            <textarea 
              [(ngModel)]="editingTaskContent" 
              class="edit-task-input"
              rows="2"
              (keyup.enter)="saveEditTask()"
              (keyup.escape)="cancelEditTask()"></textarea>
            <div class="edit-actions">
              <button (click)="saveEditTask()" class="save-edit-btn" title="Save">✓</button>
              <button (click)="cancelEditTask()" class="cancel-edit-btn" title="Cancel">×</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Completed Tasks Section -->
      <div *ngIf="completedTasks.length > 0" class="completed-section">
        <h4 class="completed-header">Completed Tasks</h4>
        <div class="completed-list">
          <div *ngFor="let task of completedTasks; let i = index" class="completed-item">
            <div class="completed-content">{{ task.content }}</div>
            <div class="completed-actions">
              <button (click)="toggleCompletedTask(i)" class="uncomplete-btn" title="Mark as incomplete">
                ↶
              </button>
              <button (click)="removeCompletedTask(i)" class="remove-btn" title="Remove">
                ×
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Picker Modal -->
  <div *ngIf="showDatePicker" class="date-picker-modal" (click)="closeDatePicker()">
    <div class="date-picker-content" (click)="$event.stopPropagation()">
      <h4>Move task to date:</h4>
      <input type="date" [(ngModel)]="selectedMoveDate" class="date-picker-input">
      <div class="date-picker-actions">
        <button (click)="confirmMoveTask()" class="confirm-btn">Move</button>
        <button (click)="closeDatePicker()" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <div class="planner-footer">
    <button (click)="saveAllTasks()" [disabled]="saving" class="save-all-btn">
      {{ saving ? 'Saving...' : 'Save All Tasks' }}
    </button>
  </div>
</div>